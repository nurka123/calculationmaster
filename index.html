<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Budget: Hybrid OS</title>
    <style>
        /* === 1. –ù–ê–°–¢–†–û–ô–ö–ò –ü–ï–†–ï–ú–ï–ù–ù–´–• === */
        :root {
            --bg-grad: radial-gradient(circle at center, #1a1a2e 0%, #0f0c29 100%);
            --bg-color: #0f0c29;
            --text-color: #ffffff;
            --accent: #00d2ff;
            --accent-sec: #c33764;
            --panel-bg: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --font-main: 'Inter', 'Segoe UI', sans-serif;
        }

        /* –¢–ï–ú–´ */
        body.theme-matrix { --bg-grad: #000000; --bg-color: #000; --text-color: #00ff41; --accent: #00ff41; --accent-sec: #008f11; --panel-bg: rgba(0, 50, 0, 0.1); --border: #00ff41; font-family: 'Courier New', monospace; }
        body.theme-gold { --bg-grad: radial-gradient(circle at center, #2b2b2b 0%, #000 100%); --bg-color: #000; --text-color: #ffd700; --accent: #ffd700; --accent-sec: #d4af37; --panel-bg: rgba(255, 215, 0, 0.05); --border: #ffd700; }
        body.theme-light { --bg-grad: #f4f7f6; --bg-color: #f4f7f6; --text-color: #333; --accent: #007bff; --accent-sec: #ff4757; --panel-bg: rgba(255,255,255,0.8); --border: #ccc; }

        /* === 2. –ë–ê–ó–ê === */
        body {
            margin: 0;
            font-family: var(--font-main);
            background: var(--bg-grad);
            background-color: var(--bg-color);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            user-select: none;
            transition: all 0.5s ease;
        }

        /* –§–û–ù–û–í–´–ï –®–ê–†–´ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–Ω–æ–ø–∫–∏) */
        .orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1; /* –ù–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ */
            pointer-events: none; /* –ü—Ä–æ–ø—É—Å–∫–∞—é—Ç –∫–ª–∏–∫–∏ */
            animation: float 10s infinite ease-in-out;
        }
        .orb-1 { top: 0; left: 0; width: 40vw; height: 40vw; background: var(--accent-sec); }
        .orb-2 { bottom: 0; right: 0; width: 40vw; height: 40vw; background: var(--accent); }
        @keyframes float { 0% { transform: translate(0,0); } 50% { transform: translate(20px, 30px); } 100% { transform: translate(0,0); } }

        /* === 3. –ö–û–ù–¢–ï–ô–ù–ï–† (–ü–ö + –ú–û–ë–ò–õ–ö–ê) === */
        .container {
            width: 90%;
            max-width: 800px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –Ω–∞ –ü–ö */
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        /* === 4. –í–ï–†–•–ù–ï–ï –ú–ï–ù–Æ === */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            width: 100%;
            max-width: 800px;
            z-index: 100;
        }

        .menu-btn {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            color: var(--text-color);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.3s;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }
        .menu-btn:hover, .menu-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 15px var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        body.theme-light .menu-btn.active { color: #fff; }

        /* === 5. –ü–ê–ù–ï–õ–ò –ò –í–í–û–î === */
        .glass-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            backdrop-filter: blur(15px);
            padding: 40px;
            border-radius: 30px;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .hero-icon { font-size: 50px; margin-bottom: 10px; display: inline-block; filter: drop-shadow(0 0 10px var(--accent)); animation: pulse 3s infinite; }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        h1 { margin: 0; font-size: 32px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        .subtitle { font-size: 14px; opacity: 0.7; margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }

        input {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            border-radius: 15px;
            border: 2px solid var(--border);
            background: rgba(0,0,0,0.2);
            color: var(--text-color);
            outline: none;
            box-sizing: border-box;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        body.theme-light input { background: #fff; color: #000; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }

        .main-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: 0.3s;
        }
        .main-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px var(--accent); }
        .main-btn:active { transform: scale(0.98); }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        #customSettings { display: none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
        .custom-row { display: flex; gap: 10px; justify-content: space-between; margin-bottom: 10px; }
        .custom-row input { margin-bottom: 0; font-size: 16px; }
        .cat-list { list-style: none; padding: 0; text-align: left; }
        .cat-item { display: flex; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.1); margin-bottom: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .delete-btn { background: none; border: none; color: var(--accent-sec); font-weight: bold; cursor: pointer; font-size: 16px; }

        /* === 6. –†–ï–ó–£–õ–¨–¢–ê–¢–´ === */
        .results-area { display: none; width: 100%; flex-direction: column; align-items: center; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .chart-box { position: relative; width: 220px; height: 220px; margin-bottom: 30px; display: flex; justify-content: center; align-items: center; }
        .donut { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; }
        .donut::after { content: ""; position: absolute; top: 15%; left: 15%; right: 15%; bottom: 15%; background: var(--bg-color); border-radius: 50%; transition: background 0.5s; }
        .chart-text { position: absolute; text-align: center; z-index: 5; pointer-events: none; }
        .chart-val { font-size: 24px; font-weight: bold; color: var(--text-color); }
        .currency-info { font-size: 12px; color: var(--accent); margin-top: 5px; font-weight: bold; }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; width: 100%; margin-bottom: 20px; }
        .card { background: var(--panel-bg); border: 1px solid var(--border); padding: 15px; border-radius: 15px; position: relative; overflow: hidden; }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .card-head { display: flex; justify-content: space-between; font-size: 12px; text-transform: uppercase; opacity: 0.8; margin-bottom: 5px; }
        .card-amount { font-size: 20px; font-weight: bold; color: var(--accent); }

        .actions { display: flex; gap: 10px; width: 100%; }
        .btn-sec { flex: 1; padding: 12px; background: transparent; border: 1px solid var(--border); color: var(--text-color); border-radius: 15px; cursor: pointer; transition: 0.3s; }
        .btn-sec:hover { background: var(--border); }

        .history { width: 100%; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
        .hist-item { display: flex; justify-content: space-between; padding: 10px; background: var(--panel-bg); margin-bottom: 5px; border-radius: 8px; font-size: 14px; }

        /* === 7. –û–†–ê–ö–£–õ –ò –ò–ì–†–ê === */
        .oracle-btn { position: fixed; bottom: 30px; left: 30px; width: 50px; height: 50px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 2px solid var(--accent); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 500; box-shadow: 0 0 20px var(--accent); transition: 0.3s; }
        .oracle-btn:hover { transform: scale(1.1); }
        .pupil { width: 15px; height: 15px; background: var(--accent); border-radius: 50%; animation: blink 4s infinite; }
        @keyframes blink { 0%,90%,100%{transform: scaleY(1);} 95%{transform: scaleY(0.1);} }
        .oracle-msg { position: fixed; bottom: 90px; left: 30px; background: rgba(0,0,0,0.9); border: 1px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 15px; max-width: 200px; display: none; z-index: 500; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-color); border: 1px solid var(--accent); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; max-height: 80vh; overflow-y: auto; color: var(--text-color); }
        
        .game-area { width: 300px; height: 300px; border: 2px solid var(--accent); border-radius: 15px; position: relative; background: rgba(0,0,0,0.5); cursor: crosshair; margin-bottom: 20px; overflow: hidden; }
        .target { width: 40px; height: 40px; background: var(--accent); border-radius: 5px; position: absolute; cursor: pointer; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 2000; transition: top 0.5s; box-shadow: 0 5px 20px var(--accent); }

        /* === 8. –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ (–ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã) === */
        @media (max-width: 600px) {
            .container { width: 100%; padding: 10px; }
            .glass-panel { padding: 25px 15px; }
            h1 { font-size: 24px; }
            .hero-icon { font-size: 40px; }
            .top-bar { gap: 5px; }
            .menu-btn { padding: 8px 12px; font-size: 12px; flex-grow: 1; justify-content: center; }
            .cards-grid { grid-template-columns: 1fr 1fr; }
            .custom-row { flex-direction: column; }
            .custom-row input { width: 100% !important; }
            .custom-row button { width: 100% !important; margin-top: 5px; }
            .oracle-btn { bottom: 20px; left: 20px; width: 45px; height: 45px; }
        }
    </style>
</head>
<body class="theme-cyber">

    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="notif" id="notif">üèÜ <span id="notifText">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</span></div>

    <div class="top-bar">
        <button class="menu-btn active" id="btnStd" onclick="setMode('std')">üî• –°—Ç–∞–Ω–¥–∞—Ä—Ç</button>
        <button class="menu-btn" id="btnCust" onclick="setMode('cust')">üõ† –°–≤–æ–π</button>
        <button class="menu-btn" onclick="openGame()">üéÆ –ò–≥—Ä–∞</button>
        <button class="menu-btn" onclick="openAch()">üèÜ –ê—á–∏–≤–∫–∏</button>
        <button class="menu-btn" onclick="changeTheme()">üé® –¢–µ–º–∞</button>
        <button class="menu-btn" onclick="openData()">üíæ –ë—ç–∫–∞–ø</button>
    </div>

    <div class="oracle-btn" onclick="askOracle()"><div class="pupil"></div></div>
    <div class="oracle-msg" id="oracleText"></div>

    <div class="container">
        <div class="glass-panel" id="inputPanel">
            <div class="hero-icon">üí†</div>
            <h1 id="mainTitle">Cyber Budget</h1>
            <p class="subtitle" id="subTitle">Hybrid System V4</p>

            <input type="text" id="amountInput" placeholder="–°—É–º–º–∞ (KZT)" inputmode="numeric">

            <div id="customSettings">
                <p style="opacity:0.6; font-size:12px; margin-bottom:5px;">–î–û–ë–ê–í–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ:</p>
                <div class="custom-row">
                    <input type="text" id="cName" placeholder="–ò–º—è">
                    <input type="number" id="cPercent" placeholder="%">
                    <button class="main-btn" style="width:auto" onclick="addCat()">+</button>
                </div>
                <ul class="cat-list" id="cList"></ul>
            </div>

            <button class="main-btn" onclick="calculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>
        </div>

        <div class="results-area" id="resultsPanel">
            <div class="chart-box">
                <div class="donut" id="donut"></div>
                <div class="chart-text">
                    <div style="font-size:10px; opacity:0.7">–í–°–ï–ì–û</div>
                    <div class="chart-val" id="resTotal">0</div>
                    <div class="currency-info" id="ratesInfo">Loading...</div>
                </div>
            </div>

            <div class="cards-grid" id="cardsBox"></div>

            <div class="actions">
                <button class="btn-sec" onclick="copyData()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-sec" onclick="resetApp()">–ù–∞–∑–∞–¥</button>
            </div>

            <div class="history">
                <div style="font-size:12px; opacity:0.5; margin-bottom:10px;">–ò–°–¢–û–†–ò–Ø</div>
                <div id="histBox"></div>
            </div>
        </div>
    </div>

    <div id="gameModal" class="modal">
        <div style="color:white; font-size:20px; margin-bottom:10px;">–°—á–µ—Ç: <span id="gScore">0</span> | –í—Ä–µ–º—è: <span id="gTime">30</span></div>
        <div class="game-area" id="gField">
            <div class="target" id="gTarget" onmousedown="hit()" ontouchstart="hit()"></div>
        </div>
        <button class="main-btn" style="width:200px" onclick="startGame()">–°—Ç–∞—Ä—Ç / –†–µ—Å—Ç–∞—Ä—Ç</button>
        <button class="btn-sec" style="width:200px; margin-top:10px; color:white; border-color:white;" onclick="closeModal('gameModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="achModal" class="modal" onclick="if(event.target===this)closeModal('achModal')">
        <div class="modal-box">
            <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
            <div id="achList" style="text-align:left;"></div>
            <button class="btn-sec" style="width:100%; margin-top:20px;" onclick="closeModal('achModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="dataModal" class="modal" onclick="if(event.target===this)closeModal('dataModal')">
        <div class="modal-box">
            <h2>–î–∞–Ω–Ω—ã–µ</h2>
            <button class="main-btn" onclick="dlData()">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
            <div style="margin:20px 0; border-top:1px solid #555; padding-top:20px;">
                <input type="file" id="ulFile" style="font-size:14px;">
                <button class="btn-sec" style="width:100%; margin-top:10px;" onclick="uplData()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <button class="btn-sec" style="width:100%;" onclick="closeModal('dataModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        /* === –ê–£–î–ò–û === */
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function beep(f=600, t=0.05) {
            if(audio.state==='suspended')audio.resume();
            const o=audio.createOscillator(), g=audio.createGain();
            o.connect(g); g.connect(audio.destination);
            o.frequency.value=f; g.gain.value=0.1;
            o.start(); o.stop(audio.currentTime+t);
        }

        /* === –ü–ï–†–ï–ú–ï–ù–ù–´–ï === */
        let rates = { USD:0.002, EUR:0.0019, CNY:0.014 };
        let mode = 'std';
        const stdCats = [{n:"–ù–∞ —Å–µ–±—è",p:60,c:"#c33764"}, {n:"–•–æ—Ç–µ–ª–∫–∏",p:15,c:"#f12711"}, {n:"–ò–Ω–≤–µ—Å—Ç",p:15,c:"#00c6ff"}, {n:"–†–æ–¥–Ω—ã–º",p:10,c:"#11998e"}];
        let custCats = JSON.parse(localStorage.getItem('sets')) || [];
        let history = JSON.parse(localStorage.getItem('hist')) || [];
        let achs = JSON.parse(localStorage.getItem('achs')) || [];
        let themeId = parseInt(localStorage.getItem('theme')) || 0;
        const themes = ['', 'theme-matrix', 'theme-gold', 'theme-light'];
        const colors = ["#FF0055","#00FF99","#00CCFF","#FFCC00","#9900FF"];
        const achList = [{id:'calc',n:'–ü–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç',i:'üöÄ'}, {id:'rich',n:'–ú–∏–ª–ª–∏–æ–Ω–µ—Ä',i:'üíé'}, {id:'game',n:'–ì–µ–π–º–µ—Ä',i:'üéÆ'}, {id:'eng',n:'–ò–Ω–∂–µ–Ω–µ—Ä',i:'üõ†'}, {id:'mag',n:'–ú–∞–≥',i:'üëÅ'}];

        /* === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø === */
        document.body.className = themes[themeId];
        document.getElementById('amountInput').addEventListener('input', function(e){
            this.value = this.value.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            beep(800, 0.02);
        });
        
        // Live –ö—É—Ä—Å
        fetch('https://api.exchangerate-api.com/v4/latest/KZT')
            .then(r=>r.json()).then(d=>{ if(d.rates) rates={USD:d.rates.USD, EUR:d.rates.EUR, CNY:d.rates.CNY}; })
            .catch(()=>console.log('Offline rates'));

        renderCust(); renderHist();

        /* === –§–£–ù–ö–¶–ò–ò === */
        function setMode(m) {
            beep(); mode = m;
            document.getElementById('btnStd').classList.remove('active');
            document.getElementById('btnCust').classList.remove('active');
            if(m==='std') { document.getElementById('btnStd').classList.add('active'); document.getElementById('customSettings').style.display='none'; }
            else { document.getElementById('btnCust').classList.add('active'); document.getElementById('customSettings').style.display='block'; }
        }

        function changeTheme() {
            beep(); themeId = (themeId+1)%themes.length;
            document.body.className = themes[themeId];
            localStorage.setItem('theme', themeId);
        }

        function addCat() {
            beep();
            const n=document.getElementById('cName').value, p=parseFloat(document.getElementById('cPercent').value);
            if(n && p) {
                if(custCats.reduce((a,b)=>a+b.p,0)+p > 100) { alert('–õ–∏–º–∏—Ç 100%!'); return; }
                custCats.push({n:n, p:p, c:colors[custCats.length%colors.length]});
                saveSets(); unlock('eng');
                document.getElementById('cName').value=''; document.getElementById('cPercent').value='';
            }
        }
        function delCat(i) { custCats.splice(i,1); saveSets(); }
        function saveSets() { localStorage.setItem('sets', JSON.stringify(custCats)); renderCust(); }
        function renderCust() {
            const l=document.getElementById('cList'); l.innerHTML='';
            custCats.forEach((c,i)=> l.innerHTML+=`<li class="cat-item"><span style="color:${c.c}">${c.n}</span><span>${c.p}% <button class="delete-btn" onclick="delCat(${i})">‚úï</button></span></li>`);
        }

        function calculate() {
            const val = parseFloat(document.getElementById('amountInput').value.replace(/\s/g,''));
            if(!val) return;
            beep(300, 0.2);
            unlock('calc'); if(val>=1000000) unlock('rich');

            const cats = (mode==='std') ? stdCats : custCats;
            if(!cats.length) { alert('–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π!'); return; }

            // –í–∞–ª—é—Ç—ã (2 –∑–Ω–∞–∫–∞)
            const u=(val*rates.USD).toFixed(2), e=(val*rates.EUR).toFixed(2), c=(val*rates.CNY).toFixed(2);
            document.getElementById('ratesInfo').innerText = `$${u} / ‚Ç¨${e} / ¬•${c}`;
            document.getElementById('resTotal').innerText = val.toLocaleString() + " ‚Ç∏";

            // –ö–∞—Ä—Ç–æ—á–∫–∏
            const grid = document.getElementById('cardsBox'); grid.innerHTML = '';
            let ang=0, grad=[], txtResult=`–ë—é–¥–∂–µ—Ç: ${val}\n`;
            cats.forEach(c => {
                const money = (val * (c.p/100));
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å –∫–æ–ø–µ–π–∫–∞–º–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                const moneyStr = money.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
                grid.innerHTML += `<div class="card" style="border-left:4px solid ${c.c}"><div class="card-head"><span>${c.n}</span><span class="card-percent">${c.p}%</span></div><div class="card-amount" style="color:${c.c}">${moneyStr}</div></div>`;
                grad.push(`${c.c} ${ang}% ${ang+c.p}%`); ang += c.p;
                txtResult += `${c.n}: ${moneyStr}\n`;
            });

            if(ang<100) grad.push(`#222 ${ang}% 100%`);
            document.getElementById('donut').style.background = `conic-gradient(${grad.join(', ')})`;
            
            window.resTxt = txtResult;
            document.getElementById('inputPanel').style.display='none';
            document.getElementById('resultsPanel').style.display='flex';

            // –ò—Å—Ç–æ—Ä–∏—è
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            history.unshift({t:time, a:val}); if(history.length>5) history.pop();
            localStorage.setItem('hist', JSON.stringify(history)); renderHist();
        }

        function renderHist() {
            const h=document.getElementById('histBox'); h.innerHTML='';
            history.forEach(x => h.innerHTML+=`<div class="hist-item"><span>${x.t}</span><span style="color:var(--accent)">+${x.a.toLocaleString()}</span></div>`);
        }

        function resetApp() { beep(); document.getElementById('inputPanel').style.display='block'; document.getElementById('resultsPanel').style.display='none'; document.getElementById('amountInput').value=''; }
        function copyData() { navigator.clipboard.writeText(window.resTxt); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'); }

        /* === –ò–ì–†–ê === */
        let score=0, gTimer, mTimer, time=30;
        function openGame() { document.getElementById('gameModal').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; clearInterval(gTimer); clearInterval(mTimer); }
        function startGame() {
            beep(); score=0; time=30; document.getElementById('gScore').innerText=0;
            document.getElementById('gTarget').style.display='block';
            clearInterval(gTimer); clearInterval(mTimer);
            moveTarget();
            gTimer = setInterval(()=>{ time--; document.getElementById('gTime').innerText=time; if(time<=0)endGame(); }, 1000);
            mTimer = setInterval(moveTarget, 600);
        }
        function moveTarget() {
            const f=document.getElementById('gField');
            const maxW=f.clientWidth-40, maxH=f.clientHeight-40;
            const t=document.getElementById('gTarget');
            t.style.top=Math.floor(Math.random()*maxH)+'px'; 
            t.style.left=Math.floor(Math.random()*maxW)+'px';
            t.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
        }
        function hit() { score++; document.getElementById('gScore').innerText=score; beep(600,0.05); if(score>=15) unlock('game'); moveTarget(); clearInterval(mTimer); mTimer=setInterval(moveTarget, 600); }
        function endGame() { clearInterval(gTimer); clearInterval(mTimer); document.getElementById('gTarget').style.display='none'; alert(`–í—Ä–µ–º—è –≤—ã—à–ª–æ! –°—á–µ—Ç: ${score}`); }

        /* === –ê–ß–ò–í–ö–ò === */
        function unlock(id) {
            if(!achs.includes(id)) {
                achs.push(id); localStorage.setItem('achs', JSON.stringify(achs));
                const n=document.getElementById('notif'); document.getElementById('notifText').innerText=achList.find(x=>x.id==id).n;
                n.style.top='20px'; setTimeout(()=>n.style.top='-100px', 3000); beep(1000,0.5);
            }
        }
        function openAch() {
            const l=document.getElementById('achList'); l.innerHTML='';
            achList.forEach(a => {
                const has = achs.includes(a.id);
                l.innerHTML += `<div style="padding:10px; margin-bottom:5px; background:rgba(255,255,255,0.1); border-radius:10px; opacity:${has?1:0.3}">
                    <span style="font-size:20px">${a.i}</span> <b>${a.n}</b>
                </div>`;
            });
            document.getElementById('achModal').style.display='flex';
        }

        /* === –û–†–ê–ö–£–õ === */
        const phrases = ["–ö–æ–ø–∏!", "–¢—Ä–∞—Ç—å —Å —É–º–æ–º", "–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π", "–†–∏—Å–∫—É–π!", "–£—á–∏—Å—å"];
        function askOracle() {
            unlock('mag'); beep();
            const m=document.getElementById('oracleText');
            if(m.style.display==='block'){m.style.display='none';return;}
            m.style.display='block'; m.innerText=phrases[Math.floor(Math.random()*phrases.length)];
        }

        /* === –î–ê–ù–ù–´–ï === */
        function openData() { document.getElementById('dataModal').style.display='flex'; }
        function dlData() {
            const d = {s:custCats, h:history, a:achs, t:themeId};
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d));
            a.download = "budget.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        function uplData() {
            const f=document.getElementById('ulFile').files[0];
            if(!f) return;
            const r=new FileReader();
            r.onload = e => {
                try {
                    const d=JSON.parse(e.target.result);
                    if(d.s)localStorage.setItem('sets',JSON.stringify(d.s));
                    if(d.h)localStorage.setItem('hist',JSON.stringify(d.h));
                    if(d.a)localStorage.setItem('achs',JSON.stringify(d.a));
                    if(d.t)localStorage.setItem('theme',d.t);
                    location.reload();
                } catch(err) { alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞'); }
            };
            r.readAsText(f);
        }
    </script>
</body>
</html>
